name: Format LaTeX Expressions

on:
  push:
    branches:
      - '**'
    paths:
      - '**.md'
      - '**.txt'
      - '**.py'
      - '**.js'

jobs:
  format-latex:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Find and format LaTeX expressions
      run: |
        python3 << 'EOF'
        import re
        import os
        import subprocess

        # èŽ·å–æœ¬æ¬¡æäº¤ä¿®æ”¹çš„æ‰€æœ‰æ–‡ä»¶
        result = subprocess.run(
            ['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'],
            capture_output=True,
            text=True
        )

        changed_files = []
        if result.returncode == 0 and result.stdout:
            changed_files = [f.strip() for f in result.stdout.strip().split('\n') if f.strip()]
        else:
            # å¦‚æžœæ˜¯åˆæ¬¡æäº¤æˆ–åˆå¹¶æäº¤ï¼Œæ£€æŸ¥æ‰€æœ‰å—æ”¯æŒçš„æ–‡ä»¶
            result = subprocess.run(
                ['git', 'ls-files'],
                capture_output=True,
                text=True
            )
            if result.returncode == 0 and result.stdout:
                all_files = [f.strip() for f in result.stdout.strip().split('\n') if f.strip()]
                supported_exts = {'.md', '.txt', '.py', '.js'}
                changed_files = [f for f in all_files if any(f.endswith(ext) for ext in supported_exts)]

        print(f"Checking files: {changed_files}")

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶
        valid_files = []
        for file_path in changed_files:
            if os.path.isfile(file_path):
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        f.read(100)
                    valid_files.append(file_path)
                except:
                    print(f"Skipping binary or unreadable file: {file_path}")

        if not valid_files:
            print("No valid text files to process")
            exit(0)

        modified_files = []

        for file_path in valid_files:
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()

                original_content = content

                # æ›¿æ¢ $$content$$ ä¸º ```math content ```
                # ç¡®ä¿ä¸æ˜¯å·²ç»æ ¼å¼åŒ–çš„ math ä»£ç å—
                pattern_double = r'\$\$([^`]+?)\$\$'
                def replace_double(match):
                    inner = match.group(1).strip()
                    return f'```math\n{inner}\n```'

                content = re.sub(pattern_double, replace_double, content, flags=re.DOTALL)

                # æ›¿æ¢ $content$ ä¸º $`content`$
                # è·³è¿‡ $$ å—å’Œä»£ç å—
                pattern_single = r'\$(?![`$])([^`\n\$]+?)(?<![`\n\$])\$'
                def replace_single(match):
                    inner = match.group(1)
                    return f'$`{inner}`$'

                # éœ€è¦æ›´å¤æ‚çš„æ›¿æ¢é€»è¾‘ï¼Œé¿å…åœ¨ä»£ç å—å†…æ›¿æ¢
                lines = content.split('\n')
                in_code_block = False
                code_block_marker = None
                new_lines = []

                for line in lines:
                    # æ£€æµ‹ä»£ç å—å¼€å§‹å’Œç»“æŸ
                    if line.strip().startswith('```'):
                        if not in_code_block:
                            in_code_block = True
                            code_block_marker = line.strip()
                        else:
                            in_code_block = False
                            code_block_marker = None

                    if not in_code_block:
                        # åœ¨éžä»£ç å—ä¸­æ›¿æ¢å•ä¸ª $
                        line = re.sub(pattern_single, replace_single, line)

                    new_lines.append(line)

                content = '\n'.join(new_lines)

                # å¦‚æžœå†…å®¹æœ‰å˜åŒ–ï¼Œå†™å›žæ–‡ä»¶
                if content != original_content:
                    with open(file_path, 'w', encoding='utf-8') as f:
                        f.write(content)
                    modified_files.append(file_path)
                    print(f"Modified: {file_path}")

            except Exception as e:
                print(f"Error processing {file_path}: {e}")
                continue

        # è®¾ç½®è¾“å‡ºå˜é‡
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            if modified_files:
                f.write(f"modified=true\n")
                f.write(f"files={','.join(modified_files)}\n")
            else:
                f.write(f"modified=false\n")
        EOF

    - name: Commit changes
      run: |
        git add -A
        if ! git diff --staged --quiet; then
          git commit -m "chore: auto-format LaTeX expressions

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push
        else
          echo "No changes to commit"
        fi
      if: steps.format-latex.outputs.modified == 'true'
