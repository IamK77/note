# 文件管理

## 文件的逻辑结构

有结构文件: 有固定结构, 如.xlsx、.csv、.json等类型  
无结构文件: 无固定结构, 如.png、.mp3、.mp4、.exe

文件目录: 相当于Windows的文件资源管理器(文件夹), MacOS的访达  
以下展示了example文件夹的目录结构

```
example
├─.vscode
├─.xmake
│  └─windows
│      └─x64
│          ├─cache
│          └─tmp
│              └─240314
├─includes
└─src
```

文件控制块(FCB): 存放文件的元数据, 存放在硬盘中, 当文件被os调用时, 也随之调入内存

索引节点: 一种类Unix系统中才有的概念, 索引节点是FCB中比较先进的一种；将文件名和文件信息分开, 文件信息单独形成一个叫inode(索引节点)的数据结构, 文件目录中只留下文件名和指向inode的指针

磁盘索引节点: 存放在硬盘中的inode  
内存索引节点: 是磁盘索引节点在内存中的副本, 用来加速访问速度

## 文件的打开过程

以Linux系统为例  

```
open(''/home/root/example.txt'', ''r'')
->系统调用
->路径解析
->目录查找
->获取磁盘inode
->加载inode到内存
->验证权限
->创建内存索引节点
->初始化文件状态
->返回文件描述符
```

系统根据给出的路径在 `/home/root/` 目录下按名查找 `example.txt` 文件, 找到后根据位于文件目录中指向inode的指针, 获取该文件的inode, 加载到内存中, 验证权限, 创建内存索引节点, 初始化文件状态(系统打开表, 引用计数等等), 最后返回文件描述符

打开文件表: 系统维护一个打开文件表, 这里的打开, 指以上步骤；表中的文件都对应一个引用计数 

引用计数: 一个文件被`x`进程使用, 这个文件在打开文件表中的引用计数就为`x`；当每有一个进程使用close系统调用关闭文件时, `引用计数－1`；当引用计数为0时, 系统从打开文件表释放相应条目  

> 注意: 用户使用open时, 仅仅将inode/fcb调入内存, 但没有将整个文件数据调入内存  

只有当用户使用`read()`、`write()`等操作时, 系统才会按需将文件数据调入内存, 且这些操作不再使用文件名, 而是使用文件描述符

文件描述符: 是操作系统提供给应用程序的一个统一接口, 由os分配给进程, 进程中每个已打开文件对应一个文件描述符；用于在进程内部操作和引用文件

## 文件的物理结构

上文说了文件的逻辑结构, 即从用户视角看到的文件, 但是实际上文件并不能像逻辑结构那样连续存放, 物理结构, 就是指文件在硬盘上的实际存储组织形式

主要有以下4种

- 连续分配: 将磁盘中连续的盘块分配给文件  
    分配时容易被已分配文件的盘块挡住道, 扩展性差, 但访问最快

- 链接分配: 
    - 隐式: 文件数据碎片化存储, 每个盘块中包含指向下一个盘块的指针, 类似链表  
      扩展性好, 但是无法随机访问, 只能顺序访问, 即如果要访问第i个盘块, 只能从第1个盘块开始遍历到第i个盘块
    - 显式: os维护一个文件分配表(FAT), 在整个磁盘中仅设置一张, 且开机时就常驻内存

FAT表

| 盘块号 | 下一块 |
|--------|--------|
|   1    |   6    |
|   2    |   20   |
|   3    |   9    |
|   4    |   30   |
|   5    |   35   |
|   6    |   8    |
|   7    |   45   |
|   8    |   -1   |
|   9    |   55   |

用`-1`表示结束, 例如第1个盘块指向第6个盘块, 第6个盘块指向第8个盘块, 第8个盘块指向`-1`, 表示结束

- 索引分配  

    为每一个文件分配一个索引块(表), 将该文件所有的盘块号都记录在索引块中, 每个盘块号对应一个指向该盘块的指针  
    索引分配可以直接访问, 也不会产生外部碎片；但索引块增加了额外的存储空间消耗  
    当文件太大而索引块太多时, 需要为这些索引块建立多级索引, 即索引块中原本指向盘块的指针改为指向下级索引块  
    多级索引块极大加快了对大型文件的查找速度；但启动磁盘的速度随索引级数的增加而增多  

## 文件的共享

- 硬链接    

    前面我们说过, 文件目录中仅保留文件名和指向inode的指针, 现在我们在两个地方各自创建一个文件, 文件名不同, 但是令指针指向同一个inode；这就是硬链接

- 软链接    

    实例就是Windows中的快捷方式, 例如QQ的快捷方式QQ.lnk, 这也是一个独立的文件, 同样拥有自己的FCB, 但是访问时, 这个文件会把你的访问导向QQ.exe, 如果QQ.exe被删除, QQ.lnk依然存在, 只是点击它时, 会说: 找不到目标文件

## 打开表

- 系统打开表    

    前面我们说过, 系统维护一个文件打开表, 是所有进程打开文件的系统级描述符表, 表项描述了一个打开文件的信息(inode指针, 访问模式, 引用计数等等)

- 用户打开表(文件描述符表)  

    各进程各自维护的本进程所有打开文件的文件描述符表, 存放在各自的PCB中, 索引值为文件描述符, 每个文件描述符对应一个指针, 指向系统打开文件表的一个表项

## 文件系统结构

分区: 一根磁盘(即硬盘)分为C盘、D盘…

扇区: 磁盘储存的最小单位, 现代硬盘以4KB作为扇区的大小

主引导记录(MBR): 位于磁盘第一个扇区的特殊数据区域, 作用是在计算机启动时加载操作系统

分区表: 存放于MBR内, 记录磁盘上分区的信息

BIOS: 主板上的固件

引导块: 包含引导操作系统的代码, 每个分区都有一个引导块, 如果分区不包含操作系统, 此内容为空；例如操作系统在C盘, D盘中引导块就为空

### 磁盘空闲空间管理

- 空闲表法: 是一种连续分配方式  
    为磁盘上所有空闲区建立一张空闲表, 表项对应一个空闲区    
    表项记录空闲区中第1个盘块号, 和空闲区中盘块数量 
    分配速度快  
    分配法参考内存的动态分配法

- 空闲链表法: 非连续    
    把磁盘所有的空闲区拉成一条空闲链；每个盘块有指向下一个盘块的指针

- 位示图法  
    以一个二维矩阵表示磁盘中盘块的使用情况  
    设该矩阵为 $ x \times y $，求第 $ z $ 块磁盘位置  
    那么坐标应是 $ \left( \frac{z}{x}, z \% y \right) $  
    如果矩阵索引由1开始，$ \left( \frac{z}{x} + 1, z \% y \right) $  
    如果由0开始，$ \left( \frac{z}{x}, z \% y - 1 \right) $

## 虚拟文件系统(VFS)

文件系统种类有FAT32、NTFS、EXT4, 各自接口也不同, 虚拟文件系统对这些文件系统的接口进行抽象化, 将它们聚合成一个统一的、标准的接口, 方便开发者使用

